<link rel="import" href="../../tangere/tangere.html" />
<link rel="import" href="../../at-theme/at-theme.html" />
<link rel="import" href="../../at-core-style-classes/at-core-style-classes.html" />

<script src="../lib/set-dom.js"></script>

<dom-module id="set-dom-demo">
  <template>
    <style include="at-core-style-classes">
      :host {
        display: block;
        box-sizing: border-box;

        margin: 4px;
        padding: 4px;
        border: 1px solid purple;
      }

      .pih {
        margin: 4px;
        padding: 4px;
        border: 1px solid purple;
      }

      .setdom {
        margin: 4px;
        padding: 4px;
        border: 1px solid purple;
      }

      .class1 {
        color: red;
      }

      .class2 {
        color: red;
        background-color: black;
      }
    </style>
    
    <div class="layout-horizontal layout-center">
      <div class="pih flex">
        <h4 class="font-body1">The contents is set via Polymer.dom(...).innerHTML</h4>
        <div id="pih" class="pih"></div>
      </div>
      <div class="setdom flex">
        <h4 class="font-body1">The contents is set via set-dom library</h4>
        <div id="setdomCont" class="setdom"><div id="setdom"></div></div>
      </div>
    </div>
    <div class="layout-horizontal layout-center-justified">
      <button type='button' class="block" on-tap="_handleClick">Change HTML</button>
      <button type='button' class="block" on-tap="_handleScopeSubtreeClick">Scope Subtree</button>
    </div>
    <div id="testResults">
    </div>
  </template>
</dom-module>
<script>
  Polymer({
    is: "set-dom-demo",
    properties: {
        
      _html1: {
        type: String,
        value: '<span id="first" class="class1">aaa</span>'
      },

      _html2: {
        type: String,
        value: '<span id="first" class="class2">bbb</span>'
      },

      _current: {
        type: Number,
        value: 1
      }

    },

    ready: function () {

      this._testInnerHTMLAndSetDomWith(this._html1);
      this._testInnerHTMLAndSetDomWith(this._html2);
      this._testInnerHTMLAndSetDomWith(this._html1);
      this._testInnerHTMLAndSetDomWith(this._html2);
      this._testInnerHTMLAndSetDomWith(this._html1);
      this._testInnerHTMLAndSetDomWith(this._html2);
      this._testInnerHTMLAndSetDomWith(this._html1);
    },

    _testInnerHTMLAndSetDomWith: function(html) {
      var setDom = this.$.setdomCont.querySelector('#setdom') || this.$.setdomCont.querySelector('#first');


      Polymer.dom(this.$.pih).innerHTML = html;
      setDOM(setDom, html);

      // assert that $.pih has html1 structure with style scoping
      var div = this.create('div', {
        id: 'pih',
        class: 'pih'
      });
      div.innerHTML = html;
      // this call removes class="pih" from div, WTF?
      this.scopeSubtree(div);
      div.setAttribute('class','pih ' + div.getAttribute('class'));
      
      var cmpRes = this.$.pih.isEqualNode(div);

      if (cmpRes) {
        Polymer.dom(this.$.testResults).innerHTML = 'Test successful';
  
      } else {
        Polymer.dom(this.$.testResults).innerHTML = 'Test failed';
      }

      // assert that $.setdomCont has html1 structure without style scoping
      div = this.create('div', {
        id: 'setdomCont'
      });
      div.setAttribute('class', 'setdom style-scope set-dom-demo');
      div.innerHTML = html;
      cmpRes = this.$.setdomCont.isEqualNode(div);

      if (cmpRes) {
        Polymer.dom(this.$.testResults).innerHTML = 'Test successful';
  
      } else {
        Polymer.dom(this.$.testResults).innerHTML = 'Test failed';
      }

      // apply style scoping to $.setdomCont
      this.scopeSubtree(this.$.setdomCont);
      this.scopeSubtree(div);

      // assert that $.setdomCont has html1 structure with style scoping
      cmpRes = this.$.setdomCont.isEqualNode(div);

      if (cmpRes) {
        Polymer.dom(this.$.testResults).innerHTML = 'Test successful';
  
      } else {
        Polymer.dom(this.$.testResults).innerHTML = 'Test failed';
      }

      // we need to set class to this value here because Polymer.Base.scopeSubtree always adds style-scope element-name, without checking if it already exists
      this.$.setdomCont.setAttribute('class', 'setdom style-scope set-dom-demo');
    },

    _handleClick: function(event) {
      if (this._current === 1) {
        Polymer.dom(this.$.pih).innerHTML = this._html2;
        var setdom = Polymer.dom(this.$.setdomCont).querySelector('#first');
        setDOM(setdom, this._html2);
        this._current = 2;

      } else {
        Polymer.dom(this.$.pih).innerHTML = this._html1;
        var setdom = Polymer.dom(this.$.setdomCont).querySelector('#first');
        setDOM(setdom, this._html1);
        this._current = 1;
      }
    },

    _handleScopeSubtreeClick: function(event) {
      this.scopeSubtree(this.$.setdomCont);
    }

  });
</script>
