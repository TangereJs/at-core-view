<!doctype html>
<html>

  <head>
    <meta charset="UTF-8">
    <title>setdom library tests</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <link rel="import" href="test-core-view-helper.html" />
    <link rel="import" href="../../at-form-text/at-form-text.html" />
    <link rel="import" href="../../iron-test-helpers/iron-test-helpers.html" />

    <script>
      window.ComponentsBase = "/components/";
    </script>
  </head>

  <body>

    <test-fixture id="innerHTMLTest">
      <template>
        <test-core-view-helper update-mode="0"></test-core-view-helper>
      </template>
    </test-fixture>

    <test-fixture id="setDomTest">
      <template>
        <test-core-view-helper update-mode="2"></test-core-view-helper>
      </template>
    </test-fixture>

    <script>
      // noru === Null or Undefined
      function isnoru(obj) {
        if (obj === null) return true;
        if (obj === undefined) return true;
        return false;
      }

      function assertContainerChildNodesEquals(elt) {
        var ihcn = elt.innerHtmlChildNodes;
        var stch = elt.setdomChildNodes;

        assert.equal(ihcn.length, stch.length);

        Array.prototype.forEach.call(ihcn, function(ihNode, index) {
          var stNode = stch[index];

          var eq = ihNode.isEqualNode(stNode);
          assert.equal(eq, true);
        });          
      }

      function assertContainerInnerHtmlEquals(elt) {
        var ihInnerHTML = Polymer.dom(elt.$.innerHtmlContainer).innerHTML;
        var sdInnerHTML = Polymer.dom(elt.$.setdomContainer).innerHTML;

        assert.equal(sdInnerHTML, ihInnerHTML);
      }

      function assertPdChildrenEquals(actNode, expNode) {
        // text nodes do not have any children; return
        if (actNode.nodeName == "#text" && expNode.nodeName == "#text") return;

        var actNodeChildren = Polymer.dom(actNode).children;
        var expNodeChildren = Polymer.dom(expNode).children;

        assert.equal(actNodeChildren.length, expNodeChildren.length);

        Array.prototype.forEach.call(actNodeChildren, function(actChild, index) {
          var expChild = expNodeChildren[index];
          var eq = actChild.isEqualNode(expChild);
          assert.equal(eq, true);
        });
      } 

      function assertPdChildNodesEquals(actNode, expNode) {
        var actNodeChildren = Polymer.dom(actNode).childNodes;
        var expNodeChildren = Polymer.dom(expNode).childNodes;
        
        assert.equal(actNodeChildren.length, expNodeChildren.length);

        actNodeChildren.forEach(function(actChild, index) {
          var expChild = expNodeChildren[index];
          var eq = actChild.isEqualNode(expChild);
          assert.equal(eq, true);
        });
      }

      function assertPdParentElementEquals(actNode, actNodeParent) {
        var parent = Polymer.dom(actNode).parentNode;
        var eq = parent.isEqualNode(actNodeParent);
        assert.equal(eq, true);
      }

      function assertPdFirstChildEquals(actNode, expNode) {
        var actFirst = Polymer.dom(actNode).firstChild;
        var expFirst = Polymer.dom(expNode).firstChild;

        if (isnoru(actFirst) && isnoru(expFirst)) return;

        var eq = actFirst.isEqualNode(expFirst);
        assert.equal(eq, true);
      }

      function assertPdLastChildEquals(actNode, expNode) {
        var actLast = Polymer.dom(actNode).lastChild;
        var expLast = Polymer.dom(expNode).lastChild;

        if (isnoru(actLast) && isnoru(expLast)) return;

        var eq = actLast.isEqualNode(expLast);
        assert.equal(eq, true);
      }

      function assertPdFirstElementChildEquals(actNode, expNode) {
        var actFirst = Polymer.dom(actNode).firstElementChild;
        var expFirst = Polymer.dom(expNode).firstElementChild;
        
        if (isnoru(actFirst) && isnoru(expFirst)) return;

        var eq = actFirst.isEqualNode(expFirst);
        assert.equal(eq, true);
      }

      function assertPdlastElementChildEquals(actNode, expNode) {
        var actLast = Polymer.dom(actNode).lastElementChild;
        var expLast = Polymer.dom(expNode).lastElementChild;

        if (isnoru(actLast) && isnoru(expLast)) return;

        var eq = actLast.isEqualNode(expLast);
        assert.equal(eq, true);
      }

      function assertPdPreviousSiblingEquals(actNode, expNode) {
        var actFirst = Polymer.dom(actNode).previousSibling;
        var expFirst = Polymer.dom(expNode).previousSibling;

        if (isnoru(actFirst) && isnoru(expFirst)) return;

        var eq = actFirst.isEqualNode(expFirst);
        assert.equal(eq, true);
      }

      function assertPdNextSiblingEquals(actNode, expNode) {
        var actLast = Polymer.dom(actNode).nextSibling;
        var expLast = Polymer.dom(expNode).nextSibling;

        if (isnoru(actLast) && isnoru(expLast)) return;

        var eq = actLast.isEqualNode(expLast);
        assert.equal(eq, true);
      }

      function assertPdTextContentEquals(actNode, expNode) {
        var actFirst = Polymer.dom(actNode).textContent;
        var expFirst = Polymer.dom(expNode).textContent;
        assert.equal(actFirst, expFirst);
      }

      function assertPdInnerHTMLEquals(actNode, expNode) {
        var actFirst = Polymer.dom(actNode).innerHTML;
        var expFirst = Polymer.dom(expNode).innerHTML;
        assert.equal(actFirst, expFirst);
      }

      function assertNodesEqual(actNode, expNode, actNodeParent, expNodeParent) {
        // Polymer.dom(parent).children
        assertPdChildrenEquals(actNode, expNode);

        // Polymer.dom(parent).childNodes
        assertPdChildNodesEquals(actNode, expNode);
        
        // Polymer.dom(node).parentNode
        assertPdParentElementEquals(actNode, actNodeParent);
        assertPdParentElementEquals(expNode, expNodeParent);

        // Polymer.dom(node).firstChild
        assertPdFirstChildEquals(actNode, expNode);

        // Polymer.dom(node).lastChild
        assertPdLastChildEquals(actNode, expNode);

        // Polymer.dom(node).firstElementChild
        assertPdFirstElementChildEquals(actNode, expNode);

        // Polymer.dom(node).lastElementChild
        assertPdlastElementChildEquals(actNode, expNode);

        // Polymer.dom(node).previousSibling
        assertPdPreviousSiblingEquals(actNode, expNode);

        // Polymer.dom(node).nextSibling
        assertPdNextSiblingEquals(actNode, expNode);
        
        // Polymer.dom(node).textContent
        assertPdTextContentEquals(actNode, expNode);

        // Polymer.dom(node).innerHTML
        assertPdInnerHTMLEquals(actNode, expNode);

        var actNodeChildNodes = Polymer.dom(actNode).childNodes;
        var expNodeChildNodes = Polymer.dom(expNode).childNodes;
        
        Array.prototype.forEach.call(actNodeChildNodes, function(node1, index) {
          var node2 = expNodeChildNodes[index];
          assertNodesEqual(node1, node2, actNode, expNode);
        });
      }

      function assertContainersEqual(cont1, cont2) {
        assertPdChildrenEquals(cont1, cont2);
        assertPdChildNodesEquals(cont1, cont2);
        assertPdInnerHTMLEquals(cont1, cont2);

        // assert that Polymer.dom api returns same results
        var expectedNodes = cont2.childNodes;
        var actualNodes = cont1.childNodes;

        Array.prototype.forEach.call(actualNodes, function(actNode, index) {
          var expNode = expectedNodes[index];
          
          assertNodesEqual(actNode, expNode, cont1, cont2);
        });
      }

      suite('compare disconnected div innerHTML with at-core-view updateMode replace', function() {
        test('test view with single element', function() {
          var elt = fixture('innerHTMLTest');

          var viewValue = '<span id="first">aaa</span>';
          elt.view = viewValue;

          var sdCont = elt.$.coreView.root;
          var ihCont = elt.$.disconnectedDiv;

          assertContainersEqual(sdCont, ihCont);

          var firstRef1 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef1.textContent, 'aaa');

          var viewValue2 = '<span id="first">bbb</span>';
          elt.view = viewValue2;

          assertContainersEqual(sdCont, ihCont);

          var firstRef2 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef2.textContent, 'bbb');

          // update mode replace is destructive so memory locations are not the same
          assert.equal(firstRef1 !== firstRef2, true);
        });

        test('test view with multiple elements making wide tree', function() {
          var elt = fixture('innerHTMLTest');

          var viewValue = '<span id="first">aaa</span>' + 
            '<span id="second">bbb</span>' + 
            '<span id="third">ccc</span>' + 
            '<span id="fourth">ddd</span>';
          elt.view = viewValue;

          var sdCont = elt.$.coreView.root;
          var ihCont = elt.$.disconnectedDiv;

          assertContainersEqual(sdCont, ihCont);

          var firstRef1 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef1.textContent, 'aaa');
          var secondRef1 = Polymer.dom(sdCont).querySelector('#second');
          assert.equal(secondRef1.textContent, 'bbb');
          var thirdRef1 = Polymer.dom(sdCont).querySelector('#third');
          assert.equal(thirdRef1.textContent, 'ccc');
          var fourthRef1 = Polymer.dom(sdCont).querySelector('#fourth');
          assert.equal(fourthRef1.textContent, 'ddd');

          var viewValue2 = '<span id="first">ddd</span>' + 
            '<span id="second">ccc</span>' + 
            '<span id="third">bbb</span>' + 
            '<span id="fourth">aaa</span>';
          elt.view = viewValue2;

          assertContainersEqual(sdCont, ihCont);

          var firstRef2 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef2.textContent, 'ddd');
          var secondRef2 = Polymer.dom(sdCont).querySelector('#second');
          assert.equal(secondRef2.textContent, 'ccc');
          var thirdRef2 = Polymer.dom(sdCont).querySelector('#third');
          assert.equal(thirdRef2.textContent, 'bbb');
          var fourthRef2 = Polymer.dom(sdCont).querySelector('#fourth');
          assert.equal(fourthRef2.textContent, 'aaa');

          // update mode replace is destructive so memory locations are not the same
          assert.equal(firstRef1 !== firstRef2, true);
          assert.equal(secondRef1 !== secondRef2, true);
          assert.equal(thirdRef1 !== thirdRef2, true);
          assert.equal(fourthRef1 !== fourthRef2, true);
        });

        test('test view with multiple elements making deep tree', function() {
          var elt = fixture('innerHTMLTest');

          var viewValue = '<span id="first">aaa<span id="second">bbb<span id="third">ccc<span id="fourth">ddd</span></span></span></span>';
          elt.view = viewValue;

          var sdCont = elt.$.coreView.root;
          var ihCont = elt.$.disconnectedDiv;

          assertContainersEqual(sdCont, ihCont);

          var firstRef1 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef1.textContent, 'aaabbbcccddd');
          var secondRef1 = Polymer.dom(sdCont).querySelector('#second');
          assert.equal(secondRef1.textContent, 'bbbcccddd');
          var thirdRef1 = Polymer.dom(sdCont).querySelector('#third');
          assert.equal(thirdRef1.textContent, 'cccddd');
          var fourthRef1 = Polymer.dom(sdCont).querySelector('#fourth');
          assert.equal(fourthRef1.textContent, 'ddd');

          var viewValue2 = '<span id="first">ddd<span id="second">ccc<span id="third">bbb<span id="fourth">aaa</span></span></span></span>';
          elt.view = viewValue2;

          assertContainersEqual(sdCont, ihCont);

          var firstRef2 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef2.textContent, 'dddcccbbbaaa');
          var secondRef2 = Polymer.dom(sdCont).querySelector('#second');
          assert.equal(secondRef2.textContent, 'cccbbbaaa');
          var thirdRef2 = Polymer.dom(sdCont).querySelector('#third');
          assert.equal(thirdRef2.textContent, 'bbbaaa');
          var fourthRef2 = Polymer.dom(sdCont).querySelector('#fourth');
          assert.equal(fourthRef2.textContent, 'aaa');

          // update mode replace is destructive so memory locations are not the same
          assert.equal(firstRef1 !== firstRef2, true);
          assert.equal(secondRef1 !== secondRef2, true);
          assert.equal(thirdRef1 !== thirdRef2, true);
          assert.equal(fourthRef1 !== fourthRef2, true);
        });

        test('test view with single custom element', function(done) {
          var elt = fixture('innerHTMLTest');

          var viewValue = '<at-form-text id="first" value="lorem"></at-form-text>';
          elt.addEventListener('content-changed', viewContentChanged1);
          elt.view = viewValue;

          var firstRef1;

          function viewContentChanged1(event) {
            elt.removeEventListener('content-changed', viewContentChanged1);

            var sdCont = elt.$.coreView.root;
            var ihCont = elt.$.disconnectedDiv;

            assertContainersEqual(sdCont, ihCont);

            firstRef1 = Polymer.dom(sdCont).querySelector('#first');
            assert.equal(firstRef1.value, 'lorem');

            var viewValue2 = '<at-form-text id="first" value="ipsum"></at-form-text>';
            elt.addEventListener('content-changed', viewContentChanged2);
            elt.view = viewValue2;
          }

          function viewContentChanged2(event) { 
            elt.removeEventListener('content-changed', viewContentChanged2);

            var sdCont = elt.$.coreView.root;
            var ihCont = elt.$.disconnectedDiv;
  
            assertContainersEqual(sdCont, ihCont);

            var firstRef2 = Polymer.dom(sdCont).querySelector('#first');
            assert.equal(firstRef2.value, 'ipsum');

            assert.equal(firstRef1 !== firstRef2, true);

            done();
          }
        });

        test('test view with multiple custom elements making a wide tree', function(done) {
          var elt = fixture('innerHTMLTest');

          var viewValue = 
            '<at-form-text id="first" value="lorem1"></at-form-text>' +
            '<at-form-text id="second" value="lorem2"></at-form-text>' + 
            '<at-form-text id="third" value="lorem3"></at-form-text>' +
            '<at-form-text id="fourth" value="lorem4"></at-form-text>';

          elt.addEventListener('content-changed', viewContentChanged1);
          elt.view = viewValue;

          var firstRef1;
          var firstRef2;
          var firstRef3;
          var firstRef4;

          function viewContentChanged1(event) {
            elt.removeEventListener('content-changed', viewContentChanged1);

            var sdCont = elt.$.coreView.root;
            var ihCont = elt.$.disconnectedDiv;

            assertContainersEqual(sdCont, ihCont);

            firstRef1 = Polymer.dom(sdCont).querySelector('#first');
            assert.equal(firstRef1.value, 'lorem1');
            secondRef1 = Polymer.dom(sdCont).querySelector('#second');
            assert.equal(secondRef1.value, 'lorem2');
            thirdRef1 = Polymer.dom(sdCont).querySelector('#third');
            assert.equal(thirdRef1.value, 'lorem3');
            fourthRef1 = Polymer.dom(sdCont).querySelector('#fourth');
            assert.equal(fourthRef1.value, 'lorem4');

            var viewValue2 = 
              '<at-form-text id="first" value="ipsum1"></at-form-text>' +
              '<at-form-text id="second" value="ipsum2"></at-form-text>' + 
              '<at-form-text id="third" value="ipsum3"></at-form-text>' +
              '<at-form-text id="fourth" value="ipsum4"></at-form-text>';

            elt.addEventListener('content-changed', viewContentChanged2);
            elt.view = viewValue2;
          }

          function viewContentChanged2(event) { 
            elt.removeEventListener('content-changed', viewContentChanged2);

            var sdCont = elt.$.coreView.root;
            var ihCont = elt.$.disconnectedDiv;
  
            assertContainersEqual(sdCont, ihCont);

            var firstRef2 = Polymer.dom(sdCont).querySelector('#first');
            assert.equal(firstRef2.value, 'ipsum1');
            var secondRef2 = Polymer.dom(sdCont).querySelector('#second');
            assert.equal(secondRef2.value, 'ipsum2');
            var thirdRef2 = Polymer.dom(sdCont).querySelector('#third');
            assert.equal(thirdRef2.value, 'ipsum3');
            var fourthRef2 = Polymer.dom(sdCont).querySelector('#fourth');
            assert.equal(fourthRef2.value, 'ipsum4');

            assert.equal(firstRef1 !== firstRef2, true);
            assert.equal(secondRef1 !== secondRef2, true);
            assert.equal(thirdRef1 !== thirdRef2, true);
            assert.equal(fourthRef1 !== fourthRef2, true);

            done();
          }
        });

      });

      suite('compare disconnected div innerHTML with at-core-view updateMode setDOM', function() {
        test('test view with single element', function() {
          var elt = fixture('setDomTest');

          var viewValue = '<span id="first">aaa</span>';
          elt.view = viewValue;

          var sdCont = elt.$.coreView.root;
          var ihCont = elt.$.disconnectedDiv;

          assertContainersEqual(sdCont, ihCont);

          var firstRef1 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef1.textContent, 'aaa');

          var viewValue2 = '<span id="first">bbb</span>';
          elt.view = viewValue2;

          assertContainersEqual(sdCont, ihCont);

          var firstRef2 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef2.textContent, 'bbb');

          // update mode replace is destructive so memory locations are not the same
          assert.equal(firstRef1 === firstRef2, true);
        });

        test('test view with multiple elements making wide tree', function() {
          var elt = fixture('setDomTest');

          var viewValue = '<span id="first">aaa</span>' + 
            '<span id="second">bbb</span>' + 
            '<span id="third">ccc</span>' + 
            '<span id="fourth">ddd</span>';
          elt.view = viewValue;

          var sdCont = elt.$.coreView.root;
          var ihCont = elt.$.disconnectedDiv;

          assertContainersEqual(sdCont, ihCont);

          var firstRef1 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef1.textContent, 'aaa');
          var secondRef1 = Polymer.dom(sdCont).querySelector('#second');
          assert.equal(secondRef1.textContent, 'bbb');
          var thirdRef1 = Polymer.dom(sdCont).querySelector('#third');
          assert.equal(thirdRef1.textContent, 'ccc');
          var fourthRef1 = Polymer.dom(sdCont).querySelector('#fourth');
          assert.equal(fourthRef1.textContent, 'ddd');

          var viewValue2 = '<span id="first">ddd</span>' + 
            '<span id="second">ccc</span>' + 
            '<span id="third">bbb</span>' + 
            '<span id="fourth">aaa</span>';
          elt.view = viewValue2;

          assertContainersEqual(sdCont, ihCont);

          var firstRef2 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef2.textContent, 'ddd');
          var secondRef2 = Polymer.dom(sdCont).querySelector('#second');
          assert.equal(secondRef2.textContent, 'ccc');
          var thirdRef2 = Polymer.dom(sdCont).querySelector('#third');
          assert.equal(thirdRef2.textContent, 'bbb');
          var fourthRef2 = Polymer.dom(sdCont).querySelector('#fourth');
          assert.equal(fourthRef2.textContent, 'aaa');

          // update mode replace is destructive so memory locations are not the same
          assert.equal(firstRef1 === firstRef2, true);
          assert.equal(secondRef1 === secondRef2, true);
          assert.equal(thirdRef1 === thirdRef2, true);
          assert.equal(fourthRef1 === fourthRef2, true);
        });

        test('test view with multiple elements making deep tree', function() {
          var elt = fixture('setDomTest');

          var viewValue = '<span id="first">aaa<span id="second">bbb<span id="third">ccc<span id="fourth">ddd</span></span></span></span>';
          elt.view = viewValue;

          var sdCont = elt.$.coreView.root;
          var ihCont = elt.$.disconnectedDiv;

          assertContainersEqual(sdCont, ihCont);

          var firstRef1 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef1.textContent, 'aaabbbcccddd');
          var secondRef1 = Polymer.dom(sdCont).querySelector('#second');
          assert.equal(secondRef1.textContent, 'bbbcccddd');
          var thirdRef1 = Polymer.dom(sdCont).querySelector('#third');
          assert.equal(thirdRef1.textContent, 'cccddd');
          var fourthRef1 = Polymer.dom(sdCont).querySelector('#fourth');
          assert.equal(fourthRef1.textContent, 'ddd');

          var viewValue2 = '<span id="first">ddd<span id="second">ccc<span id="third">bbb<span id="fourth">aaa</span></span></span></span>';
          elt.view = viewValue2;

          assertContainersEqual(sdCont, ihCont);

          var firstRef2 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef2.textContent, 'dddcccbbbaaa');
          var secondRef2 = Polymer.dom(sdCont).querySelector('#second');
          assert.equal(secondRef2.textContent, 'cccbbbaaa');
          var thirdRef2 = Polymer.dom(sdCont).querySelector('#third');
          assert.equal(thirdRef2.textContent, 'bbbaaa');
          var fourthRef2 = Polymer.dom(sdCont).querySelector('#fourth');
          assert.equal(fourthRef2.textContent, 'aaa');

          // update mode replace is destructive so memory locations are not the same
          assert.equal(firstRef1 === firstRef2, true);
          assert.equal(secondRef1 === secondRef2, true);
          assert.equal(thirdRef1 === thirdRef2, true);
          assert.equal(fourthRef1 === fourthRef2, true);
        });

        test('test view with single custom element', function(done) {
          var elt = fixture('setDomTest');

          var viewValue = '<at-form-text id="first" value="lorem"></at-form-text>';
          elt.addEventListener('content-changed', viewContentChanged1);
          elt.view = viewValue;

          var firstRef1;

          function viewContentChanged1(event) {
            elt.removeEventListener('content-changed', viewContentChanged1);

            var sdCont = elt.$.coreView.root;
            var ihCont = elt.$.disconnectedDiv;

            assertContainersEqual(sdCont, ihCont);

            firstRef1 = Polymer.dom(sdCont).querySelector('#first');
            assert.equal(firstRef1.value, 'lorem');

            var viewValue2 = '<at-form-text id="first" value="ipsum"></at-form-text>';
            elt.addEventListener('content-changed', viewContentChanged2);
            elt.view = viewValue2;
          }

          function viewContentChanged2(event) { 
            elt.removeEventListener('content-changed', viewContentChanged2);

            var sdCont = elt.$.coreView.root;
            var ihCont = elt.$.disconnectedDiv;
  
            assertContainersEqual(sdCont, ihCont);

            var firstRef2 = Polymer.dom(sdCont).querySelector('#first');
            assert.equal(firstRef2.value, 'ipsum');

            assert.equal(firstRef1 === firstRef2, true);

            done();
          }
        });

        test('test view with multiple custom elements making a wide tree', function(done) {
          var elt = fixture('setDomTest');

          var viewValue = 
            '<at-form-text id="first" value="lorem1"></at-form-text>' +
            '<at-form-text id="second" value="lorem2"></at-form-text>' + 
            '<at-form-text id="third" value="lorem3"></at-form-text>' +
            '<at-form-text id="fourth" value="lorem4"></at-form-text>';

          elt.addEventListener('content-changed', viewContentChanged1);
          elt.view = viewValue;

          var firstRef1;
          var firstRef2;
          var firstRef3;
          var firstRef4;

          function viewContentChanged1(event) {
            elt.removeEventListener('content-changed', viewContentChanged1);

            var sdCont = elt.$.coreView.root;
            var ihCont = elt.$.disconnectedDiv;

            assertContainersEqual(sdCont, ihCont);

            firstRef1 = Polymer.dom(sdCont).querySelector('#first');
            assert.equal(firstRef1.value, 'lorem1');
            secondRef1 = Polymer.dom(sdCont).querySelector('#second');
            assert.equal(secondRef1.value, 'lorem2');
            thirdRef1 = Polymer.dom(sdCont).querySelector('#third');
            assert.equal(thirdRef1.value, 'lorem3');
            fourthRef1 = Polymer.dom(sdCont).querySelector('#fourth');
            assert.equal(fourthRef1.value, 'lorem4');

            var viewValue2 = 
              '<at-form-text id="first" value="ipsum1"></at-form-text>' +
              '<at-form-text id="second" value="ipsum2"></at-form-text>' + 
              '<at-form-text id="third" value="ipsum3"></at-form-text>' +
              '<at-form-text id="fourth" value="ipsum4"></at-form-text>';

            elt.addEventListener('content-changed', viewContentChanged2);
            elt.view = viewValue2;
          }

          function viewContentChanged2(event) { 
            elt.removeEventListener('content-changed', viewContentChanged2);

            var sdCont = elt.$.coreView.root;
            var ihCont = elt.$.disconnectedDiv;
  
            assertContainersEqual(sdCont, ihCont);

            var firstRef2 = Polymer.dom(sdCont).querySelector('#first');
            assert.equal(firstRef2.value, 'ipsum1');
            var secondRef2 = Polymer.dom(sdCont).querySelector('#second');
            assert.equal(secondRef2.value, 'ipsum2');
            var thirdRef2 = Polymer.dom(sdCont).querySelector('#third');
            assert.equal(thirdRef2.value, 'ipsum3');
            var fourthRef2 = Polymer.dom(sdCont).querySelector('#fourth');
            assert.equal(fourthRef2.value, 'ipsum4');

            assert.equal(firstRef1 === firstRef2, true);
            assert.equal(secondRef1 === secondRef2, true);
            assert.equal(thirdRef1 === thirdRef2, true);
            assert.equal(fourthRef1 === fourthRef2, true);

            done();
          }
        });
      });

      suite('liquid template compare disconnected div innerHTML with at-core-view updateMode replace', function() {
        test('test template with single element', function() {
          var elt = fixture('innerHTMLTest');

          var model = {
            prop1: 'prop1Value'
          };
          elt.model = model;

          var viewValue1 = '<span id="first">aaa {{prop1}}</span>';
          elt.view = viewValue1;

          var sdCont = elt.$.coreView.root;
          var ihCont = elt.$.disconnectedDiv;

          assertContainersEqual(sdCont, ihCont);

          var firstRef1 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef1.textContent, 'aaa prop1Value');

          var viewValue2 = '<span id="first">bbb {{prop1}}</span>';
          elt.view = viewValue2;

          assertContainersEqual(sdCont, ihCont);

          var firstRef2 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef2.textContent, 'bbb prop1Value');

          assert.equal(firstRef1 !== firstRef2, true);
        });

        test('test template with multiple elements making a wide tree', function() {
          var elt = fixture('innerHTMLTest');

          var model = {
            prop1: 'prop1Value',
            prop2: 'prop2Value',
            prop3: 'prop3Value',
            prop4: 'prop4Value'
          };
          elt.model = model;

          var viewValue1 = 
            '<span id="first">aaa {{prop1}}</span>' + 
            '<span id="second">bbb {{prop2}}</span>' + 
            '<span id="third">ccc {{prop3}}</span>' + 
            '<span id="fourth">ddd {{prop4}}</span>';
          elt.view = viewValue1;

          var sdCont = elt.$.coreView.root;
          var ihCont = elt.$.disconnectedDiv;

          assertContainersEqual(sdCont, ihCont);

          var firstRef1 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef1.textContent, 'aaa prop1Value');
          var secondRef1 = Polymer.dom(sdCont).querySelector('#second');
          assert.equal(secondRef1.textContent, 'bbb prop2Value');
          var thirdRef1 = Polymer.dom(sdCont).querySelector('#third');
          assert.equal(thirdRef1.textContent, 'ccc prop3Value');
          var fourthRef1 = Polymer.dom(sdCont).querySelector('#fourth');
          assert.equal(fourthRef1.textContent, 'ddd prop4Value');

          var viewValue2 = 
            '<span id="first">ddd {{prop4}}</span>' + 
            '<span id="second">ccc {{prop2}}</span>' + 
            '<span id="third">bbb {{prop1}}</span>' + 
            '<span id="fourth">aaa {{prop3}}</span>';
          elt.view = viewValue2;

          assertContainersEqual(sdCont, ihCont);

          var firstRef2 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef2.textContent, 'ddd prop4Value');
          var secondRef2 = Polymer.dom(sdCont).querySelector('#second');
          assert.equal(secondRef2.textContent, 'ccc prop2Value');
          var thirdRef2 = Polymer.dom(sdCont).querySelector('#third');
          assert.equal(thirdRef2.textContent, 'bbb prop1Value');
          var fourthRef2 = Polymer.dom(sdCont).querySelector('#fourth');
          assert.equal(fourthRef2.textContent, 'aaa prop3Value');

          assert.equal(firstRef1 !== firstRef2, true);
          assert.equal(secondRef1 !== secondRef2, true);
          assert.equal(thirdRef1 !== thirdRef2, true);
          assert.equal(fourthRef1 !== fourthRef2, true);
        });

        test('test view with multiple elements making deep tree', function() {
          var elt = fixture('innerHTMLTest');

          var model = {
            prop1: 'prop1Value',
            prop2: 'prop2Value',
            prop3: 'prop3Value',
            prop4: 'prop4Value'
          };
          elt.model = model;          

          var viewValue1 = 
            '<span id="first">aaa {{prop1}}' +
            '<span id="second">bbb {{prop2}}' +
            '<span id="third">ccc {{prop3}}' + 
            '<span id="fourth">ddd {{prop4}}' +
            '</span></span></span></span>';
          elt.view = viewValue1;

          var sdCont = elt.$.coreView.root;
          var ihCont = elt.$.disconnectedDiv;

          assertContainersEqual(sdCont, ihCont);

          var firstRef1 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef1.textContent, 'aaa prop1Valuebbb prop2Valueccc prop3Valueddd prop4Value');
          var secondRef1 = Polymer.dom(sdCont).querySelector('#second');
          assert.equal(secondRef1.textContent, 'bbb prop2Valueccc prop3Valueddd prop4Value');
          var thirdRef1 = Polymer.dom(sdCont).querySelector('#third');
          assert.equal(thirdRef1.textContent, 'ccc prop3Valueddd prop4Value');
          var fourthRef1 = Polymer.dom(sdCont).querySelector('#fourth');
          assert.equal(fourthRef1.textContent, 'ddd prop4Value');

          var viewValue2 = 
            '<span id="first">ddd {{prop4}}' +
            '<span id="second">ccc {{prop2}}' +
            '<span id="third">bbb {{prop1}}' + 
            '<span id="fourth">aaa {{prop3}}' +
            '</span></span></span></span>';
          elt.view = viewValue2;

          var firstRef2 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef2.textContent, 'ddd prop4Valueccc prop2Valuebbb prop1Valueaaa prop3Value');
          var secondRef2 = Polymer.dom(sdCont).querySelector('#second');
          assert.equal(secondRef2.textContent, 'ccc prop2Valuebbb prop1Valueaaa prop3Value');
          var thirdRef2 = Polymer.dom(sdCont).querySelector('#third');
          assert.equal(thirdRef2.textContent, 'bbb prop1Valueaaa prop3Value');
          var fourthRef2 = Polymer.dom(sdCont).querySelector('#fourth');
          assert.equal(fourthRef2.textContent, 'aaa prop3Value');

          assert.equal(firstRef1 !== firstRef2, true);
          assert.equal(secondRef1 !== secondRef2, true);
          assert.equal(thirdRef1 !== thirdRef2, true);
          assert.equal(fourthRef1 !== fourthRef2, true);
        });

        test('test view with single custom element', function(done) {
          var elt = fixture('innerHTMLTest');

          var model = {
            prop1: 'prop1Value',
            prop2: 'prop2Value'
          };
          elt.model = model;

          var viewValue = '<at-form-text id="first" value="{{prop1}}"></at-form-text>';
          elt.addEventListener('content-changed', viewContentChanged1);
          elt.view = viewValue;

          var firstRef1;

          function viewContentChanged1(event) {
            elt.removeEventListener('content-changed', viewContentChanged1);

            var sdCont = elt.$.coreView.root;
            var ihCont = elt.$.disconnectedDiv;

            assertContainersEqual(sdCont, ihCont);

            firstRef1 = Polymer.dom(sdCont).querySelector('#first');
            assert.equal(firstRef1.value, 'prop1Value');

            var viewValue2 = '<at-form-text id="first" value="{{prop1}}" label="{{prop2}}"></at-form-text>';
            elt.addEventListener('content-changed', viewContentChanged2);
            elt.view = viewValue2;
          }

          function viewContentChanged2(event) { 
            elt.removeEventListener('content-changed', viewContentChanged2);

            var sdCont = elt.$.coreView.root;
            var ihCont = elt.$.disconnectedDiv;
  
            assertContainersEqual(sdCont, ihCont);

            var firstRef2 = Polymer.dom(sdCont).querySelector('#first');
            assert.equal(firstRef2.value, 'prop1Value');
            assert.equal(firstRef2.label, 'prop2Value');

            assert.equal(firstRef1 !== firstRef2, true);

            done();
          }
        });

        test('test view with multiple custom elements making a wide tree', function(done) {
          var elt = fixture('innerHTMLTest');

          var model = {
            value1: 'value1',
            label1: 'label1',
            value2: 'value2',
            label2: 'label2',
            value3: 'value3',
            label3: 'label3',
            value4: 'value4',
            label4: 'label4',
          };
          elt.model = model;

          var viewValue = 
            '<at-form-text id="first" value="{{value1}}"></at-form-text>' +
            '<at-form-text id="second" value="{{value2}}"></at-form-text>' + 
            '<at-form-text id="third" value="{{value3}}"></at-form-text>' +
            '<at-form-text id="fourth" value="{{value4}}"></at-form-text>';

          elt.addEventListener('content-changed', viewContentChanged1);
          elt.view = viewValue;

          var firstRef1;
          var firstRef2;
          var firstRef3;
          var firstRef4;

          function viewContentChanged1(event) {
            elt.removeEventListener('content-changed', viewContentChanged1);

            var sdCont = elt.$.coreView.root;
            var ihCont = elt.$.disconnectedDiv;

            assertContainersEqual(sdCont, ihCont);

            firstRef1 = Polymer.dom(sdCont).querySelector('#first');
            assert.equal(firstRef1.value, 'value1');
            secondRef1 = Polymer.dom(sdCont).querySelector('#second');
            assert.equal(secondRef1.value, 'value2');
            thirdRef1 = Polymer.dom(sdCont).querySelector('#third');
            assert.equal(thirdRef1.value, 'value3');
            fourthRef1 = Polymer.dom(sdCont).querySelector('#fourth');
            assert.equal(fourthRef1.value, 'value4');

            var viewValue2 = 
              '<at-form-text id="first" value="{{value1}}" label="{{label1}}"></at-form-text>' +
              '<at-form-text id="second" value="{{value2}}" label="{{label2}}"></at-form-text>' + 
              '<at-form-text id="third" value="{{value3}}" label="{{label3}}"></at-form-text>' +
              '<at-form-text id="fourth" value="{{value4}}" label="{{label4}}"></at-form-text>';

            elt.addEventListener('content-changed', viewContentChanged2);
            elt.view = viewValue2;
          }

          function viewContentChanged2(event) { 
            elt.removeEventListener('content-changed', viewContentChanged2);

            var sdCont = elt.$.coreView.root;
            var ihCont = elt.$.disconnectedDiv;
  
            assertContainersEqual(sdCont, ihCont);

            var firstRef2 = Polymer.dom(sdCont).querySelector('#first');
            assert.equal(firstRef2.value, 'value1');
            assert.equal(firstRef2.label, 'label1');
            var secondRef2 = Polymer.dom(sdCont).querySelector('#second');
            assert.equal(secondRef2.value, 'value2');
            assert.equal(secondRef2.label, 'label2');
            var thirdRef2 = Polymer.dom(sdCont).querySelector('#third');
            assert.equal(thirdRef2.value, 'value3');
            assert.equal(thirdRef2.label, 'label3');
            var fourthRef2 = Polymer.dom(sdCont).querySelector('#fourth');
            assert.equal(fourthRef2.value, 'value4');
            assert.equal(fourthRef2.label, 'label4');

            assert.equal(firstRef1 !== firstRef2, true);
            assert.equal(secondRef1 !== secondRef2, true);
            assert.equal(thirdRef1 !== thirdRef2, true);
            assert.equal(fourthRef1 !== fourthRef2, true);

            done();
          }
        });
      });

      suite('liquid template compare disconnected div innerHTML with at-core-view updateMode setDOM', function() {
        test('test template with single element', function() {
          var elt = fixture('setDomTest');

          var model = {
            prop1: 'prop1Value'
          };
          elt.model = model;

          var viewValue1 = '<span id="first">aaa {{prop1}}</span>';
          elt.view = viewValue1;

          var sdCont = elt.$.coreView.root;
          var ihCont = elt.$.disconnectedDiv;

          assertContainersEqual(sdCont, ihCont);

          var firstRef1 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef1.textContent, 'aaa prop1Value');

          var viewValue2 = '<span id="first">bbb {{prop1}}</span>';
          elt.view = viewValue2;

          assertContainersEqual(sdCont, ihCont);

          var firstRef2 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef2.textContent, 'bbb prop1Value');

          assert.equal(firstRef1 === firstRef2, true);
        });

        test('test template with multiple elements making a wide tree', function() {
          var elt = fixture('setDomTest');

          var model = {
            prop1: 'prop1Value',
            prop2: 'prop2Value',
            prop3: 'prop3Value',
            prop4: 'prop4Value'
          };
          elt.model = model;

          var viewValue1 = 
            '<span id="first">aaa {{prop1}}</span>' + 
            '<span id="second">bbb {{prop2}}</span>' + 
            '<span id="third">ccc {{prop3}}</span>' + 
            '<span id="fourth">ddd {{prop4}}</span>';
          elt.view = viewValue1;

          var sdCont = elt.$.coreView.root;
          var ihCont = elt.$.disconnectedDiv;

          assertContainersEqual(sdCont, ihCont);

          var firstRef1 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef1.textContent, 'aaa prop1Value');
          var secondRef1 = Polymer.dom(sdCont).querySelector('#second');
          assert.equal(secondRef1.textContent, 'bbb prop2Value');
          var thirdRef1 = Polymer.dom(sdCont).querySelector('#third');
          assert.equal(thirdRef1.textContent, 'ccc prop3Value');
          var fourthRef1 = Polymer.dom(sdCont).querySelector('#fourth');
          assert.equal(fourthRef1.textContent, 'ddd prop4Value');

          var viewValue2 = 
            '<span id="first">ddd {{prop4}}</span>' + 
            '<span id="second">ccc {{prop2}}</span>' + 
            '<span id="third">bbb {{prop1}}</span>' + 
            '<span id="fourth">aaa {{prop3}}</span>';
          elt.view = viewValue2;

          assertContainersEqual(sdCont, ihCont);

          var firstRef2 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef2.textContent, 'ddd prop4Value');
          var secondRef2 = Polymer.dom(sdCont).querySelector('#second');
          assert.equal(secondRef2.textContent, 'ccc prop2Value');
          var thirdRef2 = Polymer.dom(sdCont).querySelector('#third');
          assert.equal(thirdRef2.textContent, 'bbb prop1Value');
          var fourthRef2 = Polymer.dom(sdCont).querySelector('#fourth');
          assert.equal(fourthRef2.textContent, 'aaa prop3Value');

          assert.equal(firstRef1 === firstRef2, true);
          assert.equal(secondRef1 === secondRef2, true);
          assert.equal(thirdRef1 === thirdRef2, true);
          assert.equal(fourthRef1 === fourthRef2, true);
        });

        test('test view with multiple elements making deep tree', function() {
          var elt = fixture('setDomTest');

          var model = {
            prop1: 'prop1Value',
            prop2: 'prop2Value',
            prop3: 'prop3Value',
            prop4: 'prop4Value'
          };
          elt.model = model;          

          var viewValue1 = 
            '<span id="first">aaa {{prop1}}' +
            '<span id="second">bbb {{prop2}}' +
            '<span id="third">ccc {{prop3}}' + 
            '<span id="fourth">ddd {{prop4}}' +
            '</span></span></span></span>';
          elt.view = viewValue1;

          var sdCont = elt.$.coreView.root;
          var ihCont = elt.$.disconnectedDiv;

          assertContainersEqual(sdCont, ihCont);

          var firstRef1 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef1.textContent, 'aaa prop1Valuebbb prop2Valueccc prop3Valueddd prop4Value');
          var secondRef1 = Polymer.dom(sdCont).querySelector('#second');
          assert.equal(secondRef1.textContent, 'bbb prop2Valueccc prop3Valueddd prop4Value');
          var thirdRef1 = Polymer.dom(sdCont).querySelector('#third');
          assert.equal(thirdRef1.textContent, 'ccc prop3Valueddd prop4Value');
          var fourthRef1 = Polymer.dom(sdCont).querySelector('#fourth');
          assert.equal(fourthRef1.textContent, 'ddd prop4Value');

          var viewValue2 = 
            '<span id="first">ddd {{prop4}}' +
            '<span id="second">ccc {{prop2}}' +
            '<span id="third">bbb {{prop1}}' + 
            '<span id="fourth">aaa {{prop3}}' +
            '</span></span></span></span>';
          elt.view = viewValue2;

          var firstRef2 = Polymer.dom(sdCont).querySelector('#first');
          assert.equal(firstRef2.textContent, 'ddd prop4Valueccc prop2Valuebbb prop1Valueaaa prop3Value');
          var secondRef2 = Polymer.dom(sdCont).querySelector('#second');
          assert.equal(secondRef2.textContent, 'ccc prop2Valuebbb prop1Valueaaa prop3Value');
          var thirdRef2 = Polymer.dom(sdCont).querySelector('#third');
          assert.equal(thirdRef2.textContent, 'bbb prop1Valueaaa prop3Value');
          var fourthRef2 = Polymer.dom(sdCont).querySelector('#fourth');
          assert.equal(fourthRef2.textContent, 'aaa prop3Value');

          assert.equal(firstRef1 === firstRef2, true);
          assert.equal(secondRef1 === secondRef2, true);
          assert.equal(thirdRef1 === thirdRef2, true);
          assert.equal(fourthRef1 === fourthRef2, true);
        });

        test('test view with single custom element', function(done) {
          var elt = fixture('setDomTest');

          var model = {
            prop1: 'prop1Value',
            prop2: 'prop2Value'
          };
          elt.model = model;

          var viewValue = '<at-form-text id="first" value="{{prop1}}"></at-form-text>';
          elt.addEventListener('content-changed', viewContentChanged1);
          elt.view = viewValue;

          var firstRef1;

          function viewContentChanged1(event) {
            elt.removeEventListener('content-changed', viewContentChanged1);

            var sdCont = elt.$.coreView.root;
            var ihCont = elt.$.disconnectedDiv;

            assertContainersEqual(sdCont, ihCont);

            firstRef1 = Polymer.dom(sdCont).querySelector('#first');
            assert.equal(firstRef1.value, 'prop1Value');

            var viewValue2 = '<at-form-text id="first" value="{{prop1}}" label="{{prop2}}"></at-form-text>';
            elt.addEventListener('content-changed', viewContentChanged2);
            elt.view = viewValue2;
          }

          function viewContentChanged2(event) { 
            elt.removeEventListener('content-changed', viewContentChanged2);

            var sdCont = elt.$.coreView.root;
            var ihCont = elt.$.disconnectedDiv;
  
            assertContainersEqual(sdCont, ihCont);

            var firstRef2 = Polymer.dom(sdCont).querySelector('#first');
            assert.equal(firstRef2.value, 'prop1Value');
            assert.equal(firstRef2.label, 'prop2Value');

            assert.equal(firstRef1 === firstRef2, true);

            done();
          }
        });

        test('test view with multiple custom elements making a wide tree', function(done) {
          var elt = fixture('setDomTest');

          var model = {
            value1: 'value1',
            label1: 'label1',
            value2: 'value2',
            label2: 'label2',
            value3: 'value3',
            label3: 'label3',
            value4: 'value4',
            label4: 'label4',
          };
          elt.model = model;

          var viewValue = 
            '<at-form-text id="first" value="{{value1}}"></at-form-text>' +
            '<at-form-text id="second" value="{{value2}}"></at-form-text>' + 
            '<at-form-text id="third" value="{{value3}}"></at-form-text>' +
            '<at-form-text id="fourth" value="{{value4}}"></at-form-text>';

          elt.addEventListener('content-changed', viewContentChanged1);
          elt.view = viewValue;

          var firstRef1;
          var firstRef2;
          var firstRef3;
          var firstRef4;

          function viewContentChanged1(event) {
            elt.removeEventListener('content-changed', viewContentChanged1);

            var sdCont = elt.$.coreView.root;
            var ihCont = elt.$.disconnectedDiv;

            assertContainersEqual(sdCont, ihCont);

            firstRef1 = Polymer.dom(sdCont).querySelector('#first');
            assert.equal(firstRef1.value, 'value1');
            secondRef1 = Polymer.dom(sdCont).querySelector('#second');
            assert.equal(secondRef1.value, 'value2');
            thirdRef1 = Polymer.dom(sdCont).querySelector('#third');
            assert.equal(thirdRef1.value, 'value3');
            fourthRef1 = Polymer.dom(sdCont).querySelector('#fourth');
            assert.equal(fourthRef1.value, 'value4');

            var viewValue2 = 
              '<at-form-text id="first" value="{{value1}}" label="{{label1}}"></at-form-text>' +
              '<at-form-text id="second" value="{{value2}}" label="{{label2}}"></at-form-text>' + 
              '<at-form-text id="third" value="{{value3}}" label="{{label3}}"></at-form-text>' +
              '<at-form-text id="fourth" value="{{value4}}" label="{{label4}}"></at-form-text>';

            elt.addEventListener('content-changed', viewContentChanged2);
            elt.view = viewValue2;
          }

          function viewContentChanged2(event) { 
            elt.removeEventListener('content-changed', viewContentChanged2);

            var sdCont = elt.$.coreView.root;
            var ihCont = elt.$.disconnectedDiv;
  
            assertContainersEqual(sdCont, ihCont);

            var firstRef2 = Polymer.dom(sdCont).querySelector('#first');
            assert.equal(firstRef2.value, 'value1');
            assert.equal(firstRef2.label, 'label1');
            var secondRef2 = Polymer.dom(sdCont).querySelector('#second');
            assert.equal(secondRef2.value, 'value2');
            assert.equal(secondRef2.label, 'label2');
            var thirdRef2 = Polymer.dom(sdCont).querySelector('#third');
            assert.equal(thirdRef2.value, 'value3');
            assert.equal(thirdRef2.label, 'label3');
            var fourthRef2 = Polymer.dom(sdCont).querySelector('#fourth');
            assert.equal(fourthRef2.value, 'value4');
            assert.equal(fourthRef2.label, 'label4');

            assert.equal(firstRef1 === firstRef2, true);
            assert.equal(secondRef1 === secondRef2, true);
            assert.equal(thirdRef1 === thirdRef2, true);
            assert.equal(fourthRef1 === fourthRef2, true);

            done();
          }
        });
      });

    </script>

  </body>

</html>
